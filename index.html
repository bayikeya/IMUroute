<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>IMU統合版：複数画像切替付きスポット案内（自動音声版）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: white;
            font-family: sans-serif;
            text-align: center;
        }

        #camera {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 8px;
            z-index: 1;
            white-space: pre-wrap;
        }

        #image {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            object-fit: contain;
            display: none;
            z-index: 1;
            background: black;
        }

        .btn {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 2;
            display: none;
        }

        #patternBtn {
            bottom: 70px;
        }

        #nextBtn {
            bottom: 20px;
        }

        #startBtn {
            bottom: 120px;
            display: block;
        }

        /* 避難開始ボタン */
        .img-nav {
            position: absolute;
            bottom: 260px;
            z-index: 2;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 6px;
        }

        #prevBtn {
            left: 10%;
        }

        #nextImgBtn {
            right: 10%;
        }
    </style>
</head>

<body>

    <video id="camera" autoplay playsinline muted></video>
    <div id="info">位置情報・IMU取得中...</div>
    <img id="image" src="" alt="スポット画像" />
    <button class="btn" id="patternBtn" onclick="switchPattern()">English</button>
    <button class="btn" id="nextBtn" onclick="goToNextSpot()">このスポットは完了</button>
    <button class="btn" id="startBtn" onclick="startEvacuation()">避難開始</button>
    <button class="img-nav" id="prevBtn" onclick="showPrevImage()" style="display:none;">←</button>
    <button class="img-nav" id="nextImgBtn" onclick="showNextImage()" style="display:none;">→</button>
    <audio id="audio" src=""></audio>

    <script>
        const spots = [
                { name: "図書館前スロープ", lat: 35.691968142452374, lon: 140.0507643569911, radius: 0, images: ["image0.jpeg", "image1.jpeg"], audio: { A: "spot1.ja.mp3", B: "spot1.en.mp3", C: "spot1.ch.mp3" } }, //スロープ前
                { name: "１４号館前直進", lat: 35.69245264109913, lon: 140.05086356956514, radius: 10, images: ["image2.jpeg", "image10.jpeg"], audio: { A: "spot2.ja.mp3", B: "spot2.en.mp3", C: "spot2.ch.mp3" } }, //排水溝の上
                { name: "曲がり角左", lat: 35.69283599175495, lon: 140.05092001888113, radius: 10, images: ["image3.jpeg", "image11.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } }, //道の色が変わるところ
                { name: "曲がり角右１", lat: 35.692909781862724, lon: 140.05024978654654, radius: 10, images: ["image4.jpeg", "image13.jpeg"], audio: { A: "spot3,4.ja.mp3", B: "spot3,4.en.mp3", C: "spot3,4.ch.mp3" } }, //13号館のちょうど角
                { name: "曲がり角右２", lat: 35.69334894066289, lon: 140.05033682451656, radius: 10, images: ["image5.jpeg", "image14.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } }, //13号館のちょうど角
                { name: "曲がり角右３", lat: 35.69331981781718, lon: 140.05102244720183, radius: 10, images: ["image6.jpeg", "image15.jpeg"], audio: { A: "spot5,6.ja.mp3", B: "spot5,6.en.mp3", C: "spot5,6.ch.mp3" } }, //階段の前の木
                { name: "目的地", lat: 35.693014464267506, lon: 140.0509410980045, radius: 10, images: ["image7.jpeg", "image16.jpeg"], audio: { A: "spot7,8.ja.mp3", B: "spot7,8.en.mp3", C: "spot7,8.ch.mp3" } } //T字線の交点
            ];

        let currentIndex = 0;
        let hasEnteredSpot = false;
        let currentSpot = null;
        let currentPattern = "A";
        let imageIndex = 0;

        let stepCount = 0;
        let lastStepTime = 0;
        let stepDetected = false;
        let lastAccMag = 0; let stepInterval = 0;
        let lastMoveTime = Date.now();
        const STEP_LENGTH = 0.7;
        const STEP_THRESHOLD = 1.2;
        let currentSpeed = 0;

        let lastUpdateTime = null;
        let velocity = { x: 0, y: 0, z: 0 };
        let imuLat = null, imuLon = null;
        let heading = 0;

        const camera = document.getElementById("camera");
        const info = document.getElementById("info");
        const image = document.getElementById("image");
        const nextBtn = document.getElementById("nextBtn");
        const patternBtn = document.getElementById("patternBtn");
        const startBtn = document.getElementById("startBtn");
        const audio = document.getElementById("audio");
        const prevBtn = document.getElementById("prevBtn");
        const nextImgBtn = document.getElementById("nextImgBtn");

        /* --- QRコード初期座標取得 --- */
        function getQRInitialPosition() {
            const params = new URLSearchParams(window.location.search);
            const lat = parseFloat(params.get("lat"));
            const lon = parseFloat(params.get("lon"));
            if (!isNaN(lat) && !isNaN(lon)) {
                imuLat = lat;
                imuLon = lon;
                info.innerText = `QRコード補正済み位置: 緯度 ${lat.toFixed(6)}, 経度 ${lon.toFixed(6)}`;
                spots[0].lat = lat;
                spots[0].lon = lon;
            }
        }

        /* --- 避難開始ボタン用関数 --- */
        function startEvacuation() {
            getQRInitialPosition();

            currentIndex = 0;
            hasEnteredSpot = true;
            currentSpot = spots[0];
            imageIndex = 0;

            image.src = currentSpot.images[imageIndex];
            image.style.display = "block";
            nextBtn.style.display = "block";
            patternBtn.style.display = "block";
            prevBtn.style.display = currentSpot.images.length > 1 ? "block" : "none";
            nextImgBtn.style.display = currentSpot.images.length > 1 ? "block" : "none";

            audio.src = currentSpot.audio[currentPattern];
            audio.loop = true;
            audio.play().catch(e => console.log("自動再生に失敗:", e));

            checkProximity(imuLat, imuLon);

            startBtn.style.display = "none";
        }

        /* --- カメラ --- */
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
            .then(stream => camera.srcObject = stream)
            .catch(err => alert("カメラへのアクセスに失敗しました: " + err));

        /* --- 距離計算 --- */
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        /* --- スポット判定 --- */
        function checkProximity(lat, lon) {
            if (currentIndex >= spots.length) {
                info.innerText = "すべてのスポットを通過しました。";
                hideAllUI();
                return;
            }

            const spot = spots[currentIndex];
            const distance = getDistance(lat, lon, spot.lat, spot.lon);
            const range = spot.radius || 10;

            info.innerText =
                `IMU補正位置: 緯度 ${lat.toFixed(6)}, 経度 ${lon.toFixed(6)}\n` +
                `次のスポット: ${spot.name}（${currentIndex + 1} / ${spots.length}）\n` +
                `残り距離: ${distance.toFixed(1)}m\n`;

            if (currentIndex >= 1 && !hasEnteredSpot && distance < range) {
                showSpot(spot);
            }
        }

        /* --- スポット表示 --- */
        function showSpot(spot) {
            currentSpot = spot;
            hasEnteredSpot = true;
            imageIndex = 0;

            audio.src = spot.audio[currentPattern];
            image.src = spot.images[imageIndex];
            image.style.display = "block";
            nextBtn.style.display = "block";
            patternBtn.style.display = "block";
            prevBtn.style.display = spot.images.length > 1 ? "block" : "none";
            nextImgBtn.style.display = spot.images.length > 1 ? "block" : "none";

            audio.loop = true;
            audio.play().catch(e => console.log("自動再生に失敗:", e));
        }

        /* --- 音声パターン切替 --- */
        function switchPattern() {
            const patterns = ["A", "B", "C"];
            const index = patterns.indexOf(currentPattern);
            currentPattern = patterns[(index + 1) % patterns.length];
            updatePatternButtonText();

            if (currentSpot) {
                audio.pause();
                audio.src = currentSpot.audio[currentPattern];
                audio.play().catch(e => console.log("自動再生に失敗:", e));
            }
        }
        function updatePatternButtonText() {
            patternBtn.innerText = currentPattern === "A" ? "English" : currentPattern === "B" ? "中文" : "日本語";
        }

        /* --- 画像切替 --- */
        function showPrevImage() {
            if (!currentSpot) return;
            imageIndex = (imageIndex - 1 + currentSpot.images.length) % currentSpot.images.length;
            image.src = currentSpot.images[imageIndex];
        }
        function showNextImage() {
            if (!currentSpot) return;
            imageIndex = (imageIndex + 1) % currentSpot.images.length;
            image.src = currentSpot.images[imageIndex];
        }

        /* --- 次のスポットへ --- */
        function goToNextSpot() {
            audio.pause();
            currentIndex++;
            hasEnteredSpot = false;
            currentSpot = null;
            hideAllUI();
        }

        /* --- UI 非表示 --- */
        function hideAllUI() {
            image.style.display = "none";
            nextBtn.style.display = "none";
            patternBtn.style.display = "none";
            prevBtn.style.display = "none";
            nextImgBtn.style.display = "none";
        }

        /* --- IMU（加速度＋方位） --- */
        if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", (event) => {
                if (event.absolute && event.alpha != null) {
                    heading = 360 - event.alpha;
                }
            });
        }
        if (window.DeviceMotionEvent) {
            window.addEventListener("devicemotion", (event) => {
                const acc = event.accelerationIncludingGravity;
                const now = Date.now();
                if (!lastUpdateTime || !imuLat || !imuLon) {
                    lastUpdateTime = now;
                    return;
                }

                const dt = (now - lastUpdateTime) / 1000;
                lastUpdateTime = now;
                const accMag = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);

                if (accMag - lastAccMag > STEP_THRESHOLD && now - lastStepTime > 300) {
                    stepCount++;
                    stepDetected = true;
                    stepInterval = (now - lastStepTime) / 1000;
                    lastStepTime = now;
                    lastMoveTime = now;
                    currentSpeed = STEP_LENGTH / stepInterval;
                    currentSpeed = Math.min(Math.max(currentSpeed, 1.1), 2.2);
                } else {
                    stepDetected = false;
                }
                lastAccMag = accMag;

                if (now - lastMoveTime > 2000) currentSpeed = 0;

                if (currentSpeed > 0 && heading && imuLat && imuLon) {
                    const distance = currentSpeed * dt;
                    const dLat = (distance * Math.cos(heading * Math.PI / 180)) / 111111;
                    const dLon = (distance * Math.sin(heading * Math.PI / 180)) / (111111 * Math.cos(imuLat * Math.PI / 180));
                    imuLat += dLat;
                    imuLon += dLon;
                    checkProximity(imuLat, imuLon);
                }
            });
        }

        /* --- GPS --- */
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(
                pos => {
                    imuLat = pos.coords.latitude;
                    imuLon = pos.coords.longitude;
                    lastUpdateTime = Date.now();
                    checkProximity(imuLat, imuLon);
                },
                err => info.innerText = "位置情報の取得に失敗しました",
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        }

        window.onload = () => {
            getQRInitialPosition();
            updatePatternButtonText();
        };
    </script>

</body>

</html>
