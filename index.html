<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>IMU統合版：複数画像切替＋ログ記録付き</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; color: white; font-family: sans-serif; text-align: center; }
    #camera { width: 100vw; height: 100vh; object-fit: cover; position: absolute; top: 0; left: 0; z-index: -1; }
    #info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; z-index: 1; white-space: pre-wrap; }
    #image { position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%); width: 300px; height: 300px; object-fit: contain; display: none; z-index: 1; background: black; }
    .btn { position: absolute; left: 50%; transform: translateX(-50%); background-color: #007BFF; color: white; border: none; padding: 10px 20px; font-size: 14px; border-radius: 8px; cursor: pointer; z-index: 2; display: none; }
    #patternBtn { bottom: 70px; }
    #nextBtn { bottom: 20px; }
    #startBtn { bottom: 120px; display:block; }
    #logBtn { bottom: 170px; display:block; } 
    #downloadBtn { bottom: 220px; display:block; }
    .img-nav { position: absolute; bottom: 260px; z-index: 2; font-size: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 6px; }
    #prevBtn { left: 10%; }
    #nextImgBtn { right: 10%; }
  </style>
</head>
<body>

  <video id="camera" autoplay playsinline muted></video>
  <div id="info">位置情報・IMU取得中...</div>
  <img id="image" src="" alt="スポット画像" />

  <button class="btn" id="patternBtn" onclick="switchPattern()">English</button>
  <button class="btn" id="nextBtn" onclick="goToNextSpot()">このスポットは完了</button>
  <button class="btn" id="startBtn" onclick="startEvacuation()">避難開始</button>
  <button class="btn" id="logBtn" onclick="logCurrentPosition()">位置ログ記録</button>
  <button class="btn" id="downloadBtn" onclick="downloadCSV()">CSVダウンロード</button>
  <button class="img-nav" id="prevBtn" onclick="showPrevImage()" style="display:none;">←</button>
  <button class="img-nav" id="nextImgBtn" onclick="showNextImage()" style="display:none;">→</button>

  <audio id="audio" src=""></audio>

<script>
/* --- スポット設定（省略せず転記） --- */
const spots = [
  { name: "図書館前スロープ", lat: 35.691968142452374, lon: 140.0507643569911, radius: 0, images: ["image0.jpeg","image1.jpeg"], audio:{A:"spot1.ja.mp3",B:"spot1.en.mp3",C:"spot1.ch.mp3"} },
  { name: "１４号館前直進", lat:35.69244930186312, lon:140.05086185127396, radius:20, images:["image2.jpeg","image10.jpeg"], audio:{A:"spot2.ja.mp3",B:"spot2.en.mp3",C:"spot2.ch.mp3"} },
  { name: "曲がり角左", lat:35.69283234340133, lon:140.05091587321536, radius:20, images:["image3.jpeg","image11.jpeg"], audio:{A:"spot3,4.ja.mp3",B:"spot3,4.en.mp3",C:"spot3,4.ch.mp3"} },
  { name: "曲がり角右１", lat:35.69286877921128, lon:140.05030279528978, radius:20, images:["image4.jpeg","image13.jpeg"], audio:{A:"spot3,4.ja.mp3",B:"spot3,4.en.mp3",C:"spot3,4.ch.mp3"} },
  { name: "曲がり角右２", lat:35.69334894066289, lon:140.05033682451656, radius:20, images:["image5.jpeg","image14.jpeg"], audio:{A:"spot5,6.ja.mp3",B:"spot5,6.en.mp3",C:"spot5,6.ch.mp3"} },
  { name: "曲がり角右３", lat:35.69331981781718, lon:140.05102244720183, radius:20, images:["image6.jpeg","image15.jpeg"], audio:{A:"spot5,6.ja.mp3",B:"spot5,6.en.mp3",C:"spot5,6.ch.mp3"} },
  { name: "目的地", lat:35.69301023384009, lon:140.05094365865793, radius:20, images:["image7.jpeg","image16.jpeg"], audio:{A:"spot7,8.ja.mp3",B:"spot7,8.en.mp3",C:"spot7,8.ch.mp3"} }
];

let currentIndex = 0, hasEnteredSpot = false, currentSpot = null;
let currentPattern = "A", imageIndex = 0;
let imuLat = null, imuLon = null, heading = 0;
let lastUpdateTime = null, currentSpeed = 0;
let logData = [];

/* --- 各種要素 --- */
const info = document.getElementById("info");
const image = document.getElementById("image");
const audio = document.getElementById("audio");

/* --- QR初期位置 --- */
function getQRInitialPosition(){
  const params = new URLSearchParams(window.location.search);
  const lat = parseFloat(params.get("lat"));
  const lon = parseFloat(params.get("lon"));
  if(!isNaN(lat)&&!isNaN(lon)){
    imuLat=lat; imuLon=lon;
    info.innerText=`QR補正位置: 緯度${lat.toFixed(6)} 経度${lon.toFixed(6)}`;
    spots[0].lat=lat; spots[0].lon=lon;
  }
}

/* --- 避難開始 --- */
function startEvacuation(){
  getQRInitialPosition();
  currentIndex=0; hasEnteredSpot=true; currentSpot=spots[0]; imageIndex=0;
  image.src=currentSpot.images[0]; image.style.display="block";
  document.getElementById("nextBtn").style.display="block";
  document.getElementById("patternBtn").style.display="block";
  audio.src=currentSpot.audio[currentPattern]; audio.loop=true; audio.play();
  document.getElementById("startBtn").style.display="none";
}

/* --- 距離計算 --- */
function getDistance(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* --- スポット判定 --- */
function checkProximity(lat,lon){
  if(currentIndex>=spots.length){
    info.innerText="全スポット通過";
    return;
  }
  const spot=spots[currentIndex];
  const dist=getDistance(lat,lon,spot.lat,spot.lon);
  info.innerText=`IMU位置: ${lat.toFixed(6)}, ${lon.toFixed(6)}\n次: ${spot.name}\n残り: ${dist.toFixed(1)}m`;
  if(currentIndex>=1 && !hasEnteredSpot && dist<spot.radius) showSpot(spot);
}

/* --- ログ機能 --- */
function logCurrentPosition(){
  if(imuLat==null||imuLon==null){ alert("位置データ未取得"); return; }
  const spot=spots[currentIndex];
  const dist=getDistance(imuLat,imuLon,spot.lat,spot.lon).toFixed(2);
  const entry={time:new Date().toISOString(), lat:imuLat, lon:imuLon, nextSpot:spot.name, distance:dist};
  logData.push(entry);
  info.innerText=`📍ログ記録: ${entry.lat.toFixed(6)}, ${entry.lon.toFixed(6)} (${entry.distance}m)`;
  console.log(entry);
}
function downloadCSV(){
  if(logData.length===0){ alert("ログがありません"); return; }
  let csv="time,lat,lon,nextSpot,distance(m)\n";
  logData.forEach(e=>csv+=`${e.time},${e.lat},${e.lon},${e.nextSpot},${e.distance}\n`);
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="position_log.csv";
  a.click();
}

/* --- IMU更新 --- */
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation",e=>{
    if(e.absolute&&e.alpha!=null) heading=360-e.alpha;
  });
}
if(window.DeviceMotionEvent){
  window.addEventListener("devicemotion",e=>{
    if(!imuLat||!imuLon) return;
    const acc=e.accelerationIncludingGravity;
    const now=Date.now();
    if(!lastUpdateTime){ lastUpdateTime=now; return; }
    const dt=(now-lastUpdateTime)/1000; lastUpdateTime=now;
    const speed=1.4; // 簡易定速
    const dLat=(speed*dt*Math.cos(heading*Math.PI/180))/111111;
    const dLon=(speed*dt*Math.sin(heading*Math.PI/180))/(111111*Math.cos(imuLat*Math.PI/180));
    imuLat+=dLat; imuLon+=dLon;
    checkProximity(imuLat,imuLon);
  });
}

/* --- GPS --- */
if("geolocation" in navigator){
  navigator.geolocation.watchPosition(
    pos=>{
      imuLat=pos.coords.latitude; imuLon=pos.coords.longitude;
      checkProximity(imuLat,imuLon);
    },
    err=>info.innerText="位置取得失敗",
    {enableHighAccuracy:true, maximumAge:0, timeout:5000}
  );
}

window.onload=()=>{ getQRInitialPosition(); };
</script>
</body>
</html>
